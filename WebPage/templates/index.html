{% extends "layout.html" %}
{% block title %}Home · Max Fractional Matching{% endblock %}
{% block content %}
<div class="row g-4">

  <!-- ──────── Form column ──────── -->
  <div class="col-lg-5">
    <h2 class="mb-3">Enter edges</h2>

    <form id="graph-form" class="vstack gap-3" onsubmit="return false;">
      <div>
        <label for="edge-list" class="form-label fw-bold">Edges (one per line)</label>
        <textarea id="edge-list"
                  class="form-control"
                  rows="10"
                  placeholder="4 5\n4 0\n2 4\n0 2"
                  required></textarea>
        <div class="form-text">
          Line format&nbsp;=&nbsp;<code>u&nbsp;v</code>. Duplicate or reversed
          edges are ignored.
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-primary" id="btn-run">Run algorithm</button>
        <button type="button" class="btn btn-outline-secondary" id="btn-preview">Preview graph</button>
        <button type="button" class="btn btn-secondary" id="btn-random">Random example</button>

        <!-- tiny helpers -->
        <input type="number" class="form-control form-control-sm" placeholder="u" style="width:4rem" id="v-u">
        <input type="number" class="form-control form-control-sm" placeholder="v" style="width:4rem" id="v-v">
        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-edge">+ edge</button>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-vertex">+ vertex</button>
      </div>
    </form>
  </div>

  <!-- ──────── Visualization column ──────── -->
  <div class="col-lg-7">
    <h2 class="mb-3">Graph preview</h2>
    <div id="graph-area"
         class="border rounded d-flex justify-content-center align-items-center"
         style="height:520px; overflow:auto;">
      <span class="text-muted">No graph yet…</span>
    </div>
  </div>
</div>
<!-- Algorithm log ---------------------------------------------------- -->
<div class="row">
  <div class="col-12 mt-4">
    <h2 class="mb-2">Algorithm log</h2>
    <pre id="log-area"
         class="bg-dark text-white p-3 rounded"
         style="max-height:240px; overflow:auto;">
(run the algorithm to see output)
    </pre>
  </div>
</div>

<!-- ---------------------------- JS ---------------------------- -->
<script>
/* ---------- helpers ---------- */
function parseEdgeList() {
  const lines = document.getElementById("edge-list")
                 .value.split(/\r?\n/)
                 .map(l => l.trim()).filter(Boolean);
  const uniq = new Set(), edges = [];
  let maxV = -1;
  lines.forEach(l => {
    const [a, b] = l.split(/\s+/).map(Number);
    if (!Number.isInteger(a) || !Number.isInteger(b) || a === b) return;
    const [u, v] = a < b ? [a, b] : [b, a];
    const str = `${u} ${v}`;
    if (!uniq.has(str)) { uniq.add(str); edges.push(str); }
    maxV = Math.max(maxV, u, v);
  });
  return {edges, n: maxV + 1};
}

function refreshGraph(weights = []) {
  const {edges} = parseEdgeList();
  fetch("/plot", {
    method:"POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({edges, weights})
  })
  .then(r => r.json())
  .then(({img}) => {
    document.getElementById("graph-area").innerHTML =
      `<img src="${img}" alt="graph">`;
  });
}

/* ---------- bindings ---------- */
document.addEventListener("DOMContentLoaded", () => {

  document.getElementById("btn-preview").onclick = () => refreshGraph();

  document.getElementById("btn-run").onclick = () => {
    const {edges} = parseEdgeList();
    fetch("/solve", {
      method:"POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({edges})
    })
    .then(r => r.json())
    .then(({weights}) => refreshGraph(weights));
  };

  document.getElementById("btn-random").onclick = () => {
    const n = Math.floor(Math.random()*5) + 4;   // 4–8 vertices
    const set = new Set();
    while (set.size < n + 2) {
      const u = Math.floor(Math.random()*n);
      let v  = Math.floor(Math.random()*n);
      while (v === u) v = Math.floor(Math.random()*n);
      const [a,b] = u < v ? [u,v] : [v,u];
      set.add(`${a} ${b}`);
    }
    document.getElementById("edge-list").value = [...set].join("\n");
    refreshGraph();
  };

  /* mini-GUI */
  document.getElementById("btn-add-edge").onclick = () => {
    const u = document.getElementById("v-u").value.trim();
    const v = document.getElementById("v-v").value.trim();
    if (u === "" || v === "") return;
    const ta = document.getElementById("edge-list");
    ta.value += (ta.value ? "\n" : "") + `${u} ${v}`;
    refreshGraph();
  };

  document.getElementById("btn-add-vertex").onclick = () => {
    const {n} = parseEdgeList();     // next id = current count
    const ta = document.getElementById("edge-list");
    ta.value += (ta.value ? "\n" : "") + `${n} ${n}`;   // self-loop ignored
    refreshGraph();
  };
});
</script>
{% endblock %}
